name: Deploy DEV (Production Server)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Image tag to deploy (e.g., latest, development)"
        required: true
        default: "development"

env:
  REGISTRY: docker.io
  IMAGE_NAME: feerdus95/academianovit
  SSH_KEY: ${{ secrets.SSH_KEY }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_PORT: ${{ secrets.SSH_PORT }}
  TAG: ${{ github.event.inputs.tag }}

jobs:
  deploy:
    name: Deploy to Production (DEV Workflow)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH access
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "$SSH_PORT" -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Copy docker-swarm.yml to server
        run: |
          scp -P "$SSH_PORT" docker-swarm.yml "$SSH_USER@$SSH_HOST:/home/$SSH_USER/docker-swarm.yml"

      - name: Deploy to Docker Swarm (production)
        run: |
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" << EOF
            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}
            docker pull $REGISTRY/$IMAGE_NAME:$TAG
            docker stack deploy -c docker-swarm.yml academia-novit
          EOF
