name: Deploy to DEV with Docker Swarm

on:
  push:
    branches: [development]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        default: 'development'

# Environment variables
defaults:
  run:
    shell: bash

env:
  IMAGE_NAME: academianovit
  DEFAULT_TAG: development
  SSH_OPTS: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=30"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set image tag
        id: set_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ env.DEFAULT_TAG }}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          tags: ${{ env.IMAGE_NAME }}:${{ steps.set_tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Setup SSH connection
        run: |
          set -e
          echo "ðŸš€ Setting up SSH connection..."
          
          # Create .ssh directory and set permissions
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Save private key
          echo "ðŸ”‘ Saving SSH private key..."
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Add server to known_hosts
          echo "ðŸ“ Adding server to known_hosts..."
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

          # Test connection with retry logic
          MAX_RETRIES=3
          RETRY_DELAY=10
          
          for ((i=1; i<=$MAX_RETRIES; i++)); do
            echo "ðŸ”Œ Testing SSH connection on port ${{ secrets.SSH_PORT }} (Attempt $i/$MAX_RETRIES)..."
            if ssh $SSH_OPTS -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'âœ… SSH connection successful on port ${{ secrets.SSH_PORT }}'"; then
              echo "âœ… Successfully connected to ${{ secrets.SSH_HOST }}"
              break
            else
              if [ $i -eq $MAX_RETRIES ]; then
                echo "âŒ Failed to connect after $MAX_RETRIES attempts"
                exit 1
              fi
              echo "â³ Connection failed, retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done

      - name: Copy files to server
        run: |
          set -e
          echo "ðŸ“¦ Preparing files for deployment..."
          
          # Save Docker image to tar file
          IMAGE_TAR="${{ env.IMAGE_NAME }}.tar"
          echo "ðŸ’¾ Saving Docker image to $IMAGE_TAR..."
          docker save -o $IMAGE_TAR ${{ env.IMAGE_NAME }}:${{ steps.set_tag.outputs.tag }}
          
          # Copy files to server
          echo "ðŸ“¤ Transferring files to server on port ${{ secrets.SSH_PORT }}..."
          scp $SSH_OPTS -P ${{ secrets.SSH_PORT }} \
            $IMAGE_TAR \
            docker-compose.yml \
            docker-swarm.yml \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/ || {
              echo "âŒ Failed to copy files to server"
              exit 1
            }
          
          echo "âœ… Files successfully transferred to server"

      - name: Deploy with Docker Swarm
        env:
          DEPLOY_TAG: ${{ steps.set_tag.outputs.tag }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: |
          echo "ðŸš€ Starting deployment process on port ${{ secrets.SSH_PORT }}..."
          
          ssh $SSH_OPTS -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
            set -e
            
            echo "ðŸ” Deployment details:"
            echo "  - Image: $IMAGE_NAME"
            echo "  - Tag: $DEPLOY_TAG"
            echo "  - Timestamp: $(date)"
            
            # Load the Docker image
            echo "\nðŸ“¥ Loading Docker image..."
            docker load -i ~/$IMAGE_NAME.tar || {
              echo "âŒ Failed to load Docker image"
              exit 1
            }
            
            # Set environment variable for docker-compose and docker-swarm
            export IMAGE_TAG=$DEPLOY_TAG
            
            # Deploy with docker-compose (for single node testing)
            echo "\nðŸ³ Deploying with docker-compose..."
            docker-compose down 2>/dev/null || true
            docker-compose up -d
            
            # Show running containers
            echo "\nðŸ“¦ Running containers:"
            docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            # Initialize Docker Swarm if not already initialized
            if ! docker node ls &>/dev/null; then
              echo "\nðŸ Initializing Docker Swarm..."
              docker swarm init --advertise-addr 127.0.0.1 || \
                echo "âš ï¸  Swarm already initialized or error occurred"
            fi
            
            # Deploy with Docker Swarm (5 replicas)
            echo "\nðŸš€ Deploying with Docker Swarm (5 replicas)..."
            docker stack deploy -c docker-swarm.yml academia-novit
            
            # Wait for services to start
            echo "\nâ³ Waiting for services to stabilize..."
            sleep 15
            
            # Show services and their status
            echo "\nðŸ“Š Docker services status:"
            docker service ls
            
            # Show service details
            echo "\nðŸ” Service details:"
            docker service ps academia-novit_web --no-trunc || true
            
            # Show network information
            echo "\nðŸŒ Network information:"
            docker network ls
            
            # Show service logs
            echo "\nðŸ“ Service logs (last 10 lines):"
            docker service logs --tail 10 academia-novit_web 2>&1 || true
            
            # Verify service health
            echo "\nâœ… Deployment completed successfully!"
            echo "ðŸ”„ Services are being deployed with 5 replicas"
            echo "ðŸ”— API should be available shortly at: http://localhost:80"
          ENDSSH
